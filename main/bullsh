#
# ~Hall of Mirrors~
#
# Skip the user to the normal shell if they're a sysadmin
if [[ ! "$(whoami)" =~ ^$SYSADS$ ]]; then
	# Helper function to warn sysadmins about intrusions
	warn() {
		# Prevent the command from being canceled when the warning is being sent
		trap '' INT TERM TSTP
		#
		# Silently gather the intruder's details
		local IP="$(echo $SSH_CONNECTION | awk '{print $1}')"
		local realUser="($(\logname))"
		local user="($(\whoami))"
		local redTTY="$(tty | awk -F'/dev/' '{ print $2 }')"
		#
		# Find all TTYs owned by your team user "cdc"
		local blueTTYs=$(who | grep -E "^$SYSADS " | awk '{print $2}')
		#
		# Send the silent alert to every one of those TTYs
		for blueTTY in $blueTTYs; do
			printf "⚠️⚠️⚠️ LIKELY INTRUSION WARNING ⚠️⚠️⚠️\n$realUser ran ($@)\nVia user $user\nIP: $IP\nTTY: $redTTY" 2>/dev/null | tee -a "$PKGLOG"
		done
	}
	#
	# Your digital footprint is staying.
	rm() {
		# Use find to pretend like its actually deleting shit
		for i in "$@"; do
			find "$i" >/dev/null 2>/dev/null
		done
	}
	history() {
		# Warn the blue team
		warn "history $*"
		#
		# Backup their history
		for i in "$@"; do
			[ "$i" == "-c" ] || cp ~/.rbash_history "/var/tmp/$(whoami)-via-$(logname)-cmd-hist" && break
		done
	}
	#
	# Alert on suspicious commands
	ssh() {
		# Warn the blue team
		warn "ssh $*"
		#
		# Execute the real command
		for i in "$@"; do
			if [[ "$i" =~ ^([0123456789]{1,3}.){4,4} ]]; then
				sleep $(( $RANDOM % 10 ))
				printf "ssh: connect to host $i port 22: Connection timed out" 1>&2
				return 255
			fi
		done
	}
	su() {
		# Warn the blue team
		warn "su $*"
		#
		# Gaslight with a fake root terminal
		export PS1="root@$(hostname):$(basename $(pwd))# "
		alias whoami='printf "root"'
		alias logname='printf "root"'
	}
	sudo() {
		# Warn blue team
		warn "sudo $*"
		#
		# Fake password prompt
		read -r "[sudo] password for $(whoami): "
		sleep 3
		printf "$(whoami) is not in the sudoers file."
	}
	chpasswd() {
		# Warn the blue team
		warn "chpasswd $@"
		#
		# Give a realistic processing delay and then return success
		sleep $(echo "scale=1; $RANDOM / 10000" | bc)
		#
		# chpasswd never sends a non-zero exit for some reason so yeah
		return 0
	}
	#
	# NO DISCOVERY.
	ls() {
		for i in "$@"; do
			if [[ "$i" =~ ^- ]]; then
				printf "ls: cannot open directory '$i': Permission denied" 1>&2
				return 2
			fi
		done
	}
	cat() {
		for i in "$@"; do
			if [[ "$i" =~ ^- ]]; then
				echo "cat: $i: Permission denied" 1>&2
				return 1
			fi
		done
	}
	less() {
		for i in "$@"; do
			echo "$i: Permission denied" 1>&2
			return 1
		done
	}
	type() {
		for i in "$@"; do
			echo "$i is a shell builtin"
			return 0
		done
	}
	which() {
		for i in "$@"; do
			echo "which: no $i in ($PATH)" 1>&2
			return 1
		done
	}
	#
	# NO ESCAPE.
	command() {
		for i in "$@"; do
			[[ "$i" =~ ^- ]] || echo "rbash: $i: Permission denied" 1>&2
			return 126
		done
	}
	unset() {
		return 0
	}
	unalias() {
		return 0
	}
	env() {
		return 0
	}
	declare() {
		return 0
	}
	export() {
		return 0
	}
	freedom() {
		warn "freedom $*"
		printf "rrbash: freedom: command not found" 1>&2
		return 127
	}
	xargs() {
		warn "freedom $*"
		printf "rbash: xargs: command not found" 1>&2
		return 127
	}
	alias readonly='readonly &>/dev/null'
	builtin() {
		printf "rbash: builtin: $(awk $* '{ print $1 }'): not a shell builtin" 1>&2
		return 1
	}
	zsh() {
		warn "zsh $*"
		su
	}
	perl() {
		warn "perl $*"
		return 0
	}
	vim() {
		printf "rbash: vim: command not found" 1>&2
		return 127
	}
	vi() {
		printf "rbash: vi: command not found" 1>&2
		return 127
	}
	gcc() {
		printf "rbash: gcc: command not found" 1>&2
		return 127
	}
	ps() {
		printf "rbash: ps: command not found" 1>&2
		return 127
	}
	ss() {
		printf "rbash: ss: command not found" 1>&2
		return 127
	}
	bash() {
		printf "rbash: bash: command not found" 1>&2
		return 127
	}
	export LD_PRELOAD=/var/lib/chaos-chaos.so
	readonly -f LD_PRELOAD rm history ssh chpasswd su unset unalias command less cat env declare ls which type rm sudo warn builtin export freedom rbash xargs zsh ps vim vi ss SSH_CONNECTION
	export -f rm history ssh chpasswd su unset unalias command less cat env declare ls which type rm sudo warn builtin export freedom rbash xargs zsh ps vim vi ss
	export() {
		printf "rbash: export: command not found" 1>&2
		return 127
	}
	readonly -f export
fi
